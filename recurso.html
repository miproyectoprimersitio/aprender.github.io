<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repositorio Educativo con Geolocalizaci√≥n</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --primary-color: #4285f4;
            --secondary-color: #34a853;
            --drive-color: #4285f4;
            --onedrive-color: #0078d7;
            --classroom-color: #FFBC00;
            --other-color: #9c27b0;
            --error-color: #ea4335;
            --success-color: #34a853;
            --warning-color: #fbbc05;
            --dark-cyan: #008b8b;
            --light-cyan: #e0ffff;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--light-cyan);
            color: #333;
        }
        
        header {
            background: linear-gradient(135deg, var(--dark-cyan), var(--primary-color));
            color: white;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }
        
        h1 {
            margin: 0;
            font-size: 2.2rem;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        h1 i {
            margin-right: 10px;
        }
        
        header p {
            margin: 0.5rem 0 0;
            font-size: 1.1rem;
            position: relative;
            z-index: 1;
            opacity: 0.9;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .user-info {
            background-color: white;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: center;
        }
        
        .geo-badge {
            background-color: #f0f7ff;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--primary-color);
        }
        
        .street-info {
            background-color: #e8f4ff;
            border-radius: 8px;
            padding: 0.8rem 1rem;
            margin: 0.5rem 0;
            border-left: 4px solid var(--primary-color);
            width: 100%;
        }
        
        .cloud-services {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 2rem auto;
            flex-wrap: wrap;
        }
        
        .cloud-btn {
            background-color: white;
            border: none;
            border-radius: 10px;
            padding: 15px 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 180px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .cloud-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }
        
        .cloud-btn i {
            font-size: 1.5rem;
        }
        
        #googleDriveBtn {
            background-color: var(--drive-color);
            color: white;
        }
        
        #onedriveBtn {
            background-color: var(--onedrive-color);
            color: white;
        }
        
        #classroomBtn {
            background-color: var(--classroom-color);
            color: white;
        }
        
        #otherBtn {
            background-color: var(--other-color);
            color: white;
        }
        
        .link-form {
            background-color: white;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .link-form h2 {
            margin-top: 0;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }
        
        input[type="text"],
        input[type="url"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border 0.3s;
        }
        
        input[type="text"]:focus,
        input[type="url"]:focus,
        select:focus,
        textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 1.5rem;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        button:hover {
            background-color: #3367d6;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: #f1f1f1;
            color: #555;
        }
        
        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
        
        .saved-links {
            background-color: white;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .saved-links h2 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .links-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-filter {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .search-box {
            position: relative;
            min-width: 250px;
        }
        
        .search-box input {
            padding-left: 40px;
            width: 100%;
        }
        
        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #777;
        }
        
        .filter-select {
            min-width: 180px;
        }
        
        .link-item {
            padding: 1.5rem;
            border-bottom: 1px solid #eee;
            transition: all 0.3s ease;
            border-radius: 8px;
            margin-bottom: 15px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .link-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .link-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.8rem;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .link-title {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary-color);
            flex: 1;
            min-width: 200px;
        }
        
        .link-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 0.8rem;
            flex-wrap: wrap;
        }
        
        .link-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            color: #666;
            background-color: #f9f9f9;
            padding: 5px 10px;
            border-radius: 20px;
        }
        
        .link-meta-item i {
            color: var(--primary-color);
            font-size: 0.8rem;
        }
        
        .link-url {
            color: #0066cc;
            text-decoration: none;
            word-break: break-all;
            display: inline-block;
            margin-top: 5px;
            transition: color 0.2s;
        }
        
        .link-url:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }
        
        .link-description {
            margin: 0.8rem 0;
            color: #555;
            line-height: 1.5;
        }
        
        .service-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
        }
        
        .service-drive {
            background-color: var(--drive-color);
        }
        
        .service-onedrive {
            background-color: var(--onedrive-color);
        }
        
        .service-classroom {
            background-color: var(--classroom-color);
        }
        
        .service-other {
            background-color: var(--other-color);
        }
        
        .geo-info {
            background-color: #f8fbff;
            border-radius: 8px;
            padding: 0.8rem 1rem;
            margin: 1rem 0 0;
            border: 1px solid #e0e9ff;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .geo-info-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: #555;
        }
        
        .no-links {
            color: #666;
            font-style: italic;
            text-align: center;
            padding: 2rem;
            background-color: #fafafa;
            border-radius: 8px;
            border: 1px dashed #ddd;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: white;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1001;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            background-color: var(--success-color);
        }
        
        .toast.error {
            background-color: var(--error-color);
        }
        
        .toast.warning {
            background-color: var(--warning-color);
        }
        
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .tag {
            background-color: #e0e9ff;
            color: var(--primary-color);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .privacy-notice {
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        
        .privacy-button {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--secondary-color);
            color: white;
            text-decoration: none;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 1rem;
        }
        
        .privacy-button:hover {
            background-color: #2d8e47;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .cloud-services {
                flex-direction: column;
                align-items: stretch;
            }
            
            .cloud-btn {
                width: 100%;
            }
            
            .link-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .search-filter {
                width: 100%;
            }
            
            .search-box,
            .filter-select {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            header {
                padding: 1.5rem;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .link-form,
            .saved-links {
                padding: 1.5rem;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            button {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="container">
            <h1><i class="fas fa-globe-americas"></i> Repositorio Educativo con Geolocalizaci√≥n</h1>
            <p>Comparte recursos educativos con informaci√≥n de ubicaci√≥n detallada</p>
            
            <div class="privacy-notice">
                <p>El uso de esta aplicaci√≥n implica la aceptaci√≥n de nuestra Pol√≠tica de Privacidad y T√©rminos de Uso. 
                Al utilizar este servicio, aceptas que recopilamos y procesamos informaci√≥n de ubicaci√≥n para mejorar tu experiencia.</p>
                <a href="politicaprivacidad.html" class="privacy-button">Pol√≠tica de Privacidad</a>
                   
                </a>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="user-info" id="currentLocationInfo">
            <div class="geo-badge">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Detectando tu ubicaci√≥n...</span>
            </div>
        </div>

        <div class="stats-container" id="statsContainer">
            <!-- Estad√≠sticas se generar√°n din√°micamente -->
        </div>

        <div class="cloud-services">
            <button id="googleDriveBtn" class="cloud-btn">
                <i class="fab fa-google-drive"></i> Google Drive
            </button>
            <button id="onedriveBtn" class="cloud-btn">
                <i class="fas fa-cloud"></i> OneDrive
            </button>
            <button id="classroomBtn" class="cloud-btn">
                <i class="fas fa-chalkboard-teacher"></i> Classroom
            </button>
            <button id="otherBtn" class="cloud-btn">
                <i class="fas fa-link"></i> Otros Enlaces
            </button>
        </div>

        <div class="link-form">
            <h2><i class="fas fa-plus-circle"></i> Agregar Nuevo Recurso</h2>
            <form id="linkForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="linkTitle">T√≠tulo del recurso*</label>
                        <input type="text" id="linkTitle" placeholder="Ej: Apuntes de Matem√°ticas" required>
                    </div>
                    <div class="form-group">
                        <label for="linkSubject">Materia/Curso*</label>
                        <input type="text" id="linkSubject" placeholder="Ej: Matem√°ticas II" required>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="linkUrl">URL del recurso*</label>
                        <input type="url" id="linkUrl" placeholder="https://drive.google.com/..." required>
                    </div>
                    <div class="form-group">
                        <label for="linkService">Servicio*</label>
                        <select id="linkService" required>
                            <option value="">Selecciona un servicio</option>
                            <option value="drive">Google Drive</option>
                            <option value="onedrive">OneDrive</option>
                            <option value="classroom">Classroom</option>
                            <option value="other">Otro</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="linkLocation">Ubicaci√≥n (carpeta/ruta)</label>
                        <input type="text" id="linkLocation" placeholder="Ej: Carpeta Matem√°ticas/Unidad 3">
                    </div>
                    <div class="form-group">
                        <label for="linkTags">Etiquetas (separadas por comas)</label>
                        <input type="text" id="linkTags" placeholder="Ej: matem√°ticas, √°lgebra, examen">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="linkDescription">Descripci√≥n</label>
                    <textarea id="linkDescription" rows="3" placeholder="Breve descripci√≥n del recurso..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="reset" class="btn-secondary">
                        <i class="fas fa-eraser"></i> Limpiar
                    </button>
                    <button type="submit">
                        <i class="fas fa-save"></i> Guardar Recurso
                    </button>
                </div>
            </form>
        </div>

        <div class="saved-links">
            <div class="links-header">
                <h2><i class="fas fa-bookmark"></i> Recursos Guardados</h2>
                <div class="search-filter">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Buscar recursos...">
                    </div>
                    <select id="filterService" class="filter-select">
                        <option value="">Todos los servicios</option>
                        <option value="drive">Google Drive</option>
                        <option value="onedrive">OneDrive</option>
                        <option value="classroom">Classroom</option>
                        <option value="other">Otros</option>
                    </select>
                    <select id="filterSubject" class="filter-select">
                        <option value="">Todas las materias</option>
                    </select>
                </div>
            </div>
            <div id="linksContainer">
                <p class="no-links">No hay recursos guardados todav√≠a. Agrega tu primer recurso usando el formulario arriba.</p>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast" id="toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Configuraci√≥n de encriptaci√≥n mejorada
            const ENCRYPTION_CONFIG = {
                keySize: 256,
                iterations: 1000,
                algorithm: CryptoJS.algo.AES,
                mode: CryptoJS.mode.CBC,
                padding: CryptoJS.pad.Pkcs7
            };
            
            // Generar clave de encriptaci√≥n √∫nica basada en caracter√≠sticas del usuario
            function getUserEncryptionKey() {
                const userKey = [
                    navigator.userAgent,
                    navigator.hardwareConcurrency,
                    navigator.deviceMemory,
                    window.screen.width,
                    window.screen.height
                ].join('|');
                
                return CryptoJS.SHA512(userKey).toString().substring(0, 32);
            }
            
            const ENCRYPTION_KEY = getUserEncryptionKey();
            
            // Generar salt aleatorio
            function generateSalt(length = 16) {
                return CryptoJS.lib.WordArray.random(length).toString();
            }
            
            // Derivar clave usando PBKDF2
            function deriveKey(password, salt) {
                return CryptoJS.PBKDF2(password, salt, {
                    keySize: ENCRYPTION_CONFIG.keySize / 32,
                    iterations: ENCRYPTION_CONFIG.iterations
                });
            }
            
            // Generar HMAC para verificaci√≥n de integridad
            function generateHMAC(data, key) {
                return CryptoJS.HmacSHA256(JSON.stringify(data), key).toString();
            }
            
            // Verificar integridad de datos
            function verifyDataIntegrity(encryptedData, hmac, key) {
                const calculatedHmac = generateHMAC(encryptedData, key);
                return calculatedHmac === hmac;
            }
            
            // Sanitizar inputs para prevenir XSS
            function sanitizeInput(input) {
                const div = document.createElement('div');
                div.textContent = input;
                return div.innerHTML;
            }
            
            // Aplicar sanitizaci√≥n a todos los inputs
            document.querySelectorAll('input, textarea').forEach(element => {
                element.addEventListener('input', () => {
                    element.value = sanitizeInput(element.value);
                });
            });
            
            // Generar clave √∫nica para almacenamiento
            function getStorageKey() {
                const userKey = btoa(navigator.userAgent + window.screen.width + window.screen.height);
                return `er_${CryptoJS.SHA256(userKey).toString().substr(0, 16)}`;
            }
            
            // Encriptar datos con configuraci√≥n mejorada
            function encryptData(data) {
                const salt = generateSalt();
                const key = deriveKey(ENCRYPTION_KEY, salt);
                const iv = CryptoJS.lib.WordArray.random(128/8);
                
                const encrypted = CryptoJS.AES.encrypt(JSON.stringify(data), key, {
                    iv: iv,
                    mode: ENCRYPTION_CONFIG.mode,
                    padding: ENCRYPTION_CONFIG.padding
                });
                
                return {
                    ciphertext: encrypted.toString(),
                    iv: iv.toString(),
                    salt: salt
                };
            }
            
            // Desencriptar datos
            function decryptData(encryptedData) {
                try {
                    const key = deriveKey(ENCRYPTION_KEY, encryptedData.salt);
                    const decrypted = CryptoJS.AES.decrypt(encryptedData.ciphertext, key, {
                        iv: CryptoJS.enc.Hex.parse(encryptedData.iv),
                        mode: ENCRYPTION_CONFIG.mode,
                        padding: ENCRYPTION_CONFIG.padding
                    });
                    
                    return JSON.parse(decrypted.toString(CryptoJS.enc.Utf8));
                } catch (e) {
                    console.error('Error al desencriptar datos:', e);
                    return null;
                }
            }
            
            // Elementos del DOM
            const linkForm = document.getElementById('linkForm');
            const linksContainer = document.getElementById('linksContainer');
            const searchInput = document.getElementById('searchInput');
            const filterService = document.getElementById('filterService');
            const filterSubject = document.getElementById('filterSubject');
            const toast = document.getElementById('toast');
            const statsContainer = document.getElementById('statsContainer');
            const currentLocationInfo = document.getElementById('currentLocationInfo');
            
            let links = [];
            let geoData = {
                ip: 'No detectada',
                country: 'No detectado',
                city: 'No detectada',
                region: 'N/D',
                street: 'N/D',
                neighborhood: 'N/D',
                location: 'Ubicaci√≥n no disponible',
                timezone: 'N/D',
                org: 'N/D',
                latitude: null,
                longitude: null
            };
            
            // Obtener informaci√≥n de geolocalizaci√≥n mejorada
            function getEnhancedGeoData() {
                return new Promise((resolve) => {
                    // Primero intentamos con la API de ipapi.co para datos b√°sicos
                    fetch('https://ipapi.co/json/')
                        .then(response => response.json())
                        .then(data => {
                            const baseData = {
                                ip: data.ip || 'No detectada',
                                country: data.country_name || 'No detectado',
                                city: data.city || 'No detectada',
                                region: data.region || 'N/D',
                                street: 'N/D',
                                neighborhood: 'N/D',
                                location: `${data.city || 'Ubicaci√≥n'} - ${data.country_name || 'No detectada'}`,
                                timezone: data.timezone || 'N/D',
                                org: data.org || 'N/D',
                                latitude: null,
                                longitude: null
                            };
                            
                            // Si el usuario permite geolocalizaci√≥n precisa, intentamos obtener m√°s datos
                            if (navigator.geolocation) {
                                navigator.geolocation.getCurrentPosition(position => {
                                    baseData.latitude = position.coords.latitude;
                                    baseData.longitude = position.coords.longitude;
                                    
                                    // Usamos Nominatim (OpenStreetMap) para obtener direcci√≥n inversa
                                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}`)
                                        .then(response => response.json())
                                        .then(locationData => {
                                            const address = locationData.address || {};
                                            const enhancedData = {
                                                ...baseData,
                                                street: address.road || address.pedestrian || address.footway || 'N/D',
                                                neighborhood: address.suburb || 
                                                             address.neighbourhood || 
                                                             address.quarter || 
                                                             address.city_district || 'N/D',
                                                city: address.city || address.town || address.village || baseData.city,
                                                region: address.state || address.region || baseData.region
                                            };
                                            resolve(enhancedData);
                                        })
                                        .catch(() => resolve(baseData));
                                }, () => resolve(baseData), {
                                    enableHighAccuracy: true,
                                    timeout: 5000,
                                    maximumAge: 0
                                });
                            } else {
                                resolve(baseData);
                            }
                        })
                        .catch(error => {
                            console.error('Error al obtener geolocalizaci√≥n:', error);
                            resolve(geoData); // Devuelve los valores por defecto
                        });
                });
            }
            
            // Actualizar la informaci√≥n de ubicaci√≥n en la UI
            function updateLocationInfo() {
                currentLocationInfo.innerHTML = `
                    <div class="geo-badge">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Detectando tu ubicaci√≥n...</span>
                    </div>
                `;
                
                getEnhancedGeoData().then(data => {
                    geoData = data;
                    
                    let locationHTML = `
                        <div class="geo-badge">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${geoData.city || 'Ubicaci√≥n'}, ${geoData.region || 'Provincia'}, ${geoData.country || 'Pa√≠s'}</span>
                        </div>
                        <div class="geo-badge">
                            <i class="fas fa-network-wired"></i>
                            <span>IP: ${geoData.ip}</span>
                        </div>
                    `;
                    
                    // Mostrar informaci√≥n detallada de calle y barrio si est√° disponible
                    if (geoData.street !== 'N/D' || geoData.neighborhood !== 'N/D') {
                        locationHTML += `
                            <div class="street-info">
                                <div><i class="fas fa-road"></i> <strong>Calle:</strong> ${geoData.street}</div>
                                <div><i class="fas fa-map-signs"></i> <strong>Barrio:</strong> ${geoData.neighborhood}</div>
                                ${geoData.latitude && geoData.longitude ? `
                                    <div><i class="fas fa-map-pin"></i> <strong>Coordenadas:</strong> 
                                        ${geoData.latitude.toFixed(4)}, ${geoData.longitude.toFixed(4)}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                    
                    currentLocationInfo.innerHTML = locationHTML;
                });
            }
            
            // Guardar enlaces con encriptaci√≥n mejorada
            function saveLinks() {
                const storageKey = getStorageKey();
                const dataToSave = {
                    links: links,
                    version: '1.0',
                    timestamp: Date.now()
                };
                
                const encrypted = encryptData(dataToSave);
                const hmac = generateHMAC(encrypted, ENCRYPTION_KEY);
                
                localStorage.setItem(storageKey, JSON.stringify({
                    data: encrypted,
                    hmac: hmac
                }));
            }
            
            // Cargar enlaces con verificaci√≥n de integridad
            function loadLinks() {
                const storageKey = getStorageKey();
                const savedData = localStorage.getItem(storageKey);
                
                if (!savedData) {
                    links = [];
                    return;
                }
                
                try {
                    const parsedData = JSON.parse(savedData);
                    
                    if (!verifyDataIntegrity(parsedData.data, parsedData.hmac, ENCRYPTION_KEY)) {
                        showToast('Los datos han sido alterados', 'error');
                        return;
                    }
                    
                    const decrypted = decryptData(parsedData.data);
                    
                    if (decrypted && decrypted.links) {
                        links = decrypted.links;
                    } else {
                        links = [];
                    }
                } catch (e) {
                    console.error('Error al cargar datos:', e);
                    links = [];
                }
            }
            
            // Verificar integridad al cargar la p√°gina
            function verifyDataOnLoad() {
                const storageKey = getStorageKey();
                const savedData = localStorage.getItem(storageKey);
                
                if (savedData) {
                    try {
                        const parsedData = JSON.parse(savedData);
                        if (!verifyDataIntegrity(parsedData.data, parsedData.hmac, ENCRYPTION_KEY)) {
                            showToast('Advertencia: Los datos han sido modificados externamente', 'warning');
                        }
                    } catch (e) {
                        console.error('Error verificando integridad:', e);
                    }
                }
            }
            
            // Inicializar la aplicaci√≥n
            function initApp() {
                verifyDataOnLoad();
                updateLocationInfo();
                loadLinks();
                setupEventListeners();
                renderLinks();
                renderStats();
                updateSubjectFilter();
            }
            
            // Configurar event listeners
            function setupEventListeners() {
                // Formulario principal
                linkForm.addEventListener('submit', handleFormSubmit);
                
                // B√∫squeda y filtros
                searchInput.addEventListener('input', debounce(renderLinks, 300));
                filterService.addEventListener('change', renderLinks);
                filterSubject.addEventListener('change', renderLinks);
                
                // Botones de servicios en la nube
                document.getElementById('googleDriveBtn').addEventListener('click', () => {
                    document.getElementById('linkService').value = 'drive';
                    document.getElementById('linkUrl').focus();
                });
                
                document.getElementById('onedriveBtn').addEventListener('click', () => {
                    document.getElementById('linkService').value = 'onedrive';
                    document.getElementById('linkUrl').focus();
                });
                
                document.getElementById('classroomBtn').addEventListener('click', () => {
                    document.getElementById('linkService').value = 'classroom';
                    document.getElementById('linkUrl').focus();
                });
                
                document.getElementById('otherBtn').addEventListener('click', () => {
                    document.getElementById('linkService').value = 'other';
                    document.getElementById('linkUrl').focus();
                });
            }
            
            // Manejar env√≠o del formulario principal
            function handleFormSubmit(e) {
                e.preventDefault();
                
                const title = document.getElementById('linkTitle').value.trim();
                const subject = document.getElementById('linkSubject').value.trim();
                const url = document.getElementById('linkUrl').value.trim();
                const location = document.getElementById('linkLocation').value.trim();
                const service = document.getElementById('linkService').value;
                const description = document.getElementById('linkDescription').value.trim();
                const tags = document.getElementById('linkTags').value.trim();
                
                // Validar URL
                if (!isValidUrl(url)) {
                    showToast('Por favor ingresa una URL v√°lida', 'error');
                    return;
                }
                
                // Validar servicio
                if (!service) {
                    showToast('Por favor selecciona un servicio', 'error');
                    return;
                }
                
                // Obtener fecha y hora actual
                const now = new Date();
                const date = now.toLocaleDateString();
                const time = now.toLocaleTimeString();
                
                // Usamos los datos geogr√°ficos actuales
                const newLink = {
                    id: Date.now(),
                    title,
                    subject,
                    url,
                    location,
                    service,
                    description,
                    tags: tags ? tags.split(',').map(tag => tag.trim()) : [],
                    date: `${date} ${time}`,
                    timestamp: now.getTime(),
                    geoData: {...geoData} // Copia de los datos geogr√°ficos actuales
                };
                
                // Agregar el nuevo recurso
                links.push(newLink);
                saveLinks();
                renderLinks();
                renderStats();
                updateSubjectFilter();
                
                // Resetear el formulario
                linkForm.reset();
                
                showToast('Recurso guardado exitosamente', 'success');
            }
            
            // Mostrar los enlaces con filtros aplicados
            function renderLinks() {
                linksContainer.innerHTML = '';
                
                const searchTerm = searchInput.value.toLowerCase();
                const serviceFilter = filterService.value;
                const subjectFilter = filterSubject.value;
                
                let filteredLinks = links.filter(link => {
                    const matchesSearch = 
                        link.title.toLowerCase().includes(searchTerm) ||
                        link.subject.toLowerCase().includes(searchTerm) ||
                        (link.description && link.description.toLowerCase().includes(searchTerm)) ||
                        link.tags.some(tag => tag.toLowerCase().includes(searchTerm));
                    
                    const matchesService = serviceFilter ? link.service === serviceFilter : true;
                    const matchesSubject = subjectFilter ? link.subject === subjectFilter : true;
                    
                    return matchesSearch && matchesService && matchesSubject;
                });
                
                if (filteredLinks.length === 0) {
                    linksContainer.innerHTML = `
                        <p class="no-links">
                            <i class="fas fa-search" style="font-size: 1.5rem; margin-bottom: 10px;"></i><br>
                            No se encontraron recursos que coincidan con tu b√∫squeda.
                        </p>
                    `;
                    return;
                }
                
                // Ordenar por fecha m√°s reciente primero
                filteredLinks.sort((a, b) => b.timestamp - a.timestamp);
                
                filteredLinks.forEach(link => {
                    const linkElement = document.createElement('div');
                    linkElement.className = 'link-item';
                    
                    let serviceClass = '';
                    let serviceName = '';
                    
                    switch(link.service) {
                        case 'drive':
                            serviceClass = 'service-drive';
                            serviceName = 'Google Drive';
                            break;
                        case 'onedrive':
                            serviceClass = 'service-onedrive';
                            serviceName = 'OneDrive';
                            break;
                        case 'classroom':
                            serviceClass = 'service-classroom';
                            serviceName = 'Classroom';
                            break;
                        case 'other':
                            serviceClass = 'service-other';
                            serviceName = 'Otro';
                            break;
                    }
                    
                    // Construir la informaci√≥n de geolocalizaci√≥n
                    let geoInfoHTML = `
                        <div class="geo-info">
                            <div class="geo-info-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <span><strong>Ubicaci√≥n:</strong> ${link.geoData.city || 'N/D'}, ${link.geoData.region || 'N/D'}, ${link.geoData.country || 'N/D'}</span>
                            </div>
                    `;
                    
                    // Mostrar informaci√≥n detallada de calle y barrio si est√° disponible
                    if (link.geoData.street !== 'N/D' || link.geoData.neighborhood !== 'N/D') {
                        geoInfoHTML += `
                            <div class="geo-info-item">
                                <i class="fas fa-road"></i>
                                <span><strong>Calle:</strong> ${link.geoData.street}</span>
                            </div>
                            <div class="geo-info-item">
                                <i class="fas fa-map-signs"></i>
                                <span><strong>Barrio:</strong> ${link.geoData.neighborhood}</span>
                            </div>
                        `;
                    }
                    
                    // Mostrar coordenadas si est√°n disponibles
                    if (link.geoData.latitude && link.geoData.longitude) {
                        geoInfoHTML += `
                            <div class="geo-info-item">
                                <i class="fas fa-map-pin"></i>
                                <span><strong>Coordenadas:</strong> 
                                    ${link.geoData.latitude.toFixed(4)}, ${link.geoData.longitude.toFixed(4)}
                                </span>
                            </div>
                        `;
                    }
                    
                    geoInfoHTML += `
                            <div class="geo-info-item">
                                <i class="fas fa-network-wired"></i>
                                <span><strong>IP:</strong> ${link.geoData.ip || 'N/D'}</span>
                            </div>
                            <div class="geo-info-item">
                                <i class="fas fa-clock"></i>
                                <span><strong>Zona horaria:</strong> ${link.geoData.timezone || 'N/D'}</span>
                            </div>
                        </div>
                    `;
                    
                    linkElement.innerHTML = `
                        <div class="link-header">
                            <div class="link-title">${link.title}</div>
                        </div>
                        <div class="link-meta">
                            <div class="link-meta-item">
                                <i class="fas fa-book"></i>
                                <span>${link.subject}</span>
                            </div>
                            <div class="link-meta-item">
                                <i class="fas fa-folder"></i>
                                <span>${link.location || 'Sin ubicaci√≥n especificada'}</span>
                            </div>
                            <div class="link-meta-item">
                                <i class="fas fa-calendar-alt"></i>
                                <span>${link.date}</span>
                            </div>
                            <div class="link-meta-item">
                                <i class="fas fa-cloud"></i>
                                <span class="${serviceClass} service-tag">${serviceName}</span>
                            </div>
                        </div>
                        ${link.description ? `<div class="link-description">${link.description}</div>` : ''}
                        <div class="link-meta">
                            <div class="link-meta-item">
                                <i class="fas fa-link"></i>
                                <a href="${link.url}" class="link-url" target="_blank">${link.url}</a>
                            </div>
                        </div>
                        
                        ${link.tags.length > 0 ? `
                            <div class="link-meta">
                                <div class="link-meta-item">
                                    <i class="fas fa-tags"></i>
                                    <div class="tags-container">
                                        ${link.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${geoInfoHTML}
                    `;
                    
                    linksContainer.appendChild(linkElement);
                });
            }
            
            // Actualizar filtro de materias
            function updateSubjectFilter() {
                const subjects = [...new Set(links.map(link => link.subject))].sort();
                filterSubject.innerHTML = '<option value="">Todas las materias</option>';
                
                subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    filterSubject.appendChild(option);
                });
            }
            
            // Mostrar estad√≠sticas
            function renderStats() {
                const totalLinks = links.length;
                const driveCount = links.filter(link => link.service === 'drive').length;
                const onedriveCount = links.filter(link => link.service === 'onedrive').length;
                const classroomCount = links.filter(link => link.service === 'classroom').length;
                const otherCount = links.filter(link => link.service === 'other').length;
                
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: var(--primary-color);">
                            <i class="fas fa-link"></i>
                        </div>
                        <div class="stat-value">${totalLinks}</div>
                        <div class="stat-label">Recursos Totales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: var(--drive-color);">
                            <i class="fab fa-google-drive"></i>
                        </div>
                        <div class="stat-value">${driveCount}</div>
                        <div class="stat-label">Google Drive</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: var(--onedrive-color);">
                            <i class="fas fa-cloud"></i>
                        </div>
                        <div class="stat-value">${onedriveCount}</div>
                        <div class="stat-label">OneDrive</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: var(--classroom-color);">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <div class="stat-value">${classroomCount}</div>
                        <div class="stat-label">Classroom</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: var(--other-color);">
                            <i class="fas fa-link"></i>
                        </div>
                        <div class="stat-value">${otherCount}</div>
                        <div class="stat-label">Otros Enlaces</div>
                    </div>
                `;
            }
            
            // Mostrar notificaci√≥n toast
            function showToast(message, type = 'success') {
                toast.textContent = message;
                toast.className = `toast show ${type}`;
                
                setTimeout(() => {
                    toast.className = 'toast';
                }, 3000);
            }
            
            // Validar URL
            function isValidUrl(string) {
                try {
                    new URL(string);
                    return true;
                } catch (_) {
                    return false;
                }
            }
            
            // Debounce para mejorar rendimiento en b√∫squedas
            function debounce(func, wait) {
                let timeout;
                return function() {
                    const context = this, args = arguments;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        func.apply(context, args);
                    }, wait);
                };
            }
            
            // Iniciamos la aplicaci√≥n
            initApp();
        });
          // 1. Configuraci√≥n de Supabase (REMPLAZA CON TUS DATOS)
        const supabaseUrl = 'https://tu-proyecto.supabase.co';
        const supabaseKey = 'tu-clave-publica-supabase';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // 2. Funci√≥n para guardar en Supabase
        async function saveToSupabase(linkData) {
            const { data, error } = await supabase
                .from('recursos')
                .insert([linkData])
                .select();
            
            if (error) {
                console.error("Error al guardar:", error);
                showToast('Error al guardar en la nube', 'error');
                return false;
            }
            console.log("Guardado en Supabase:", data);
            return true;
        }

        // 3. Modificar handleFormSubmit para usar Supabase
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const newLink = {
                id: Date.now(),
                title: document.getElementById('linkTitle').value.trim(),
                subject: document.getElementById('linkSubject').value.trim(),
                url: document.getElementById('linkUrl').value.trim(),
                service: document.getElementById('linkService').value,
                location: document.getElementById('linkLocation').value.trim(),
                description: document.getElementById('linkDescription').value.trim(),
                tags: document.getElementById('linkTags').value.trim().split(',').map(tag => tag.trim()),
                geoData: {...geoData}, // Copia de los datos geolocalizaci√≥n
                created_at: new Date().toISOString()
            };

            // Guardar localmente (como ya lo hac√≠as)
            links.push(newLink);
            saveLinks();
            
            // Guardar en Supabase
            const cloudSuccess = await saveToSupabase(newLink);
            
            if (cloudSuccess) {
                showToast('Recurso guardado local y en la nube', 'success');
            } else {
                showToast('Recurso guardado localmente (error en la nube)', 'warning');
            }
            
            renderLinks();
            renderStats();
            updateSubjectFilter();
            linkForm.reset();
        }

        // 4. Funci√≥n para cargar datos desde Supabase al iniciar
        async function loadFromSupabase() {
            const { data, error } = await supabase
                .from('recursos')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (!error && data) {
                links = data;
                saveLinks(); // Guarda en localStorage tambi√©n
                renderLinks();
                renderStats();
                updateSubjectFilter();
            }
        }

        // 5. Modificar initApp para cargar desde Supabase
        function initApp() {
            verifyDataOnLoad();
            updateLocationInfo();
            loadLinks(); // Carga desde localStorage primero
            loadFromSupabase(); // Luego actualiza desde Supabase
            setupEventListeners();
            renderLinks();
            renderStats();
            updateSubjectFilter();
        }
    </script>
</body>
</html>